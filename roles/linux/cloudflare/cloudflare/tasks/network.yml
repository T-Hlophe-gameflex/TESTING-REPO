---
- name: cloudflare network | display configuration banner
  ansible.builtin.debug:
    msg: "Configuring network settings for {{ cloudflare_zone_name }}..."
  tags:
    - cloudflare_configuration
    - cloudflare_network

- name: cloudflare network | Display dry-run health check creation
  ansible.builtin.debug:
    msg:
      - "ðŸ” DRY-RUN: Would CREATE health check:"
      - "  Name: {{ item.name }}"
      - "  Address: {{ item.address }}"
      - "  Type: {{ item.type | default('https') }}"
      - "  Path: {{ item.path | default('/') }}"
  loop: "{{ cloudflare_network_health_checks | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - cloudflare_dry_run | default(false) | bool
    - cloudflare_zone_id is defined
    - cloudflare_network_health_checks | length > 0
  tags:
    - cloudflare_configuration
    - cloudflare_network
    - cloudflare_health_checks

- name: cloudflare network | create health checks
  ansible.builtin.uri:
    url: "{{ cloudflare_api_url }}/zones/{{ cloudflare_zone_id }}/healthchecks"
    method: POST
    headers:
      X-Auth-Email: "{{ cloudflare_api_email }}"
      X-Auth-Key: "{{ cloudflare_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.name }}"
      description: "{{ item.description | default('Health check for ' + item.name) }}"
      check_regions: "{{ item.check_regions | default(['WEU', 'ENAM']) }}"
      type: "{{ item.type | default('https') }}"
      address: "{{ item.address }}"
      port: "{{ item.port | default(443) }}"
      path: "{{ item.path | default('/') }}"
      interval: "{{ item.interval | default(60) }}"
      retries: "{{ item.retries | default(2) }}"
      timeout: "{{ item.timeout | default(5) }}"
      expected_codes: "{{ item.expected_codes | default('200') }}"
      expected_body: "{{ item.expected_body | default('') }}"
      follow_redirects: "{{ item.follow_redirects | default(false) }}"
      allow_insecure: "{{ item.allow_insecure | default(false) }}"
    status_code: [200, 409]
    return_content: true
  loop: "{{ cloudflare_network_health_checks | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  register: _health_checks_result
  when:
    - not (cloudflare_dry_run | default(false) | bool)
    - cloudflare_zone_id is defined
    - cloudflare_network_health_checks | length > 0
  changed_when: _health_checks_result.status == 200
  failed_when: false  
  tags:
    - cloudflare_configuration
    - cloudflare_network
    - cloudflare_health_checks

- name: cloudflare network | enable IP Geolocation
  ansible.builtin.uri:
    url: "{{ cloudflare_api_url }}/zones/{{ cloudflare_zone_id }}/settings/ip_geolocation"
    method: PATCH
    headers:
      X-Auth-Email: "{{ cloudflare_api_email }}"
      X-Auth-Key: "{{ cloudflare_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      value: "{{ 'on' if cloudflare_network_ip_geolocation.enabled else 'off' }}"
    status_code: [200, 400]
    return_content: true
  register: _ip_geolocation_result
  when:
    - cloudflare_zone_id is defined
    - cloudflare_network_ip_geolocation is defined
    - cloudflare_network_ip_geolocation.enabled is defined
  changed_when: 
    - _ip_geolocation_result.status == 200
    - _ip_geolocation_result.json.success | default(false)
  failed_when: false
  tags:
    - cloudflare_configuration
    - cloudflare_network
    - cloudflare_ip_geolocation

- name: cloudflare network | display IP Geolocation status
  ansible.builtin.debug:
    msg:
      - "IP Geolocation Configuration:"
      - "  Status Code: {{ _ip_geolocation_result.status | default('N/A') }}"
      - "  Success: {{ _ip_geolocation_result.json.success | default('N/A') }}"
      - "  Setting Value: {{ _ip_geolocation_result.json.result.value | default('N/A') }}"
      - "  Errors: {{ _ip_geolocation_result.json.errors | default([]) }}"
      - "  Messages: {{ _ip_geolocation_result.json.messages | default([]) }}"
  when:
    - _ip_geolocation_result is defined
    - _ip_geolocation_result.json is defined
  tags:
    - cloudflare_configuration
    - cloudflare_network
    - cloudflare_ip_geolocation

- name: cloudflare network | display network configuration summary
  ansible.builtin.debug:
    msg:
      - "Network configuration applied"
      - "Health Checks: {{ cloudflare_network_health_checks | default([]) | length }}"
      - "IP Geolocation: {{ 'Enabled' if (cloudflare_network_ip_geolocation.enabled | default(false)) else 'Disabled' }}"
  tags:
    - cloudflare_configuration
    - cloudflare_network
