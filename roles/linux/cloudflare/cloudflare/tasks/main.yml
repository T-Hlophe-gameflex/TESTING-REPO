---

- name: cloudflare | Store original dry-run value from survey
  ansible.builtin.set_fact:
    _original_dry_run_value: "{{ cloudflare_dry_run | default(false) }}"
  tags:
    - always

- name: cloudflare | Set dry-run mode
  ansible.builtin.set_fact:
    cloudflare_dry_run: "{{ ansible_check_mode | default(false) or (_original_dry_run_value if _original_dry_run_value is boolean else (_original_dry_run_value | string | lower == 'true')) }}"
  tags:
    - always

- name: cloudflare | Display dry-run mode status
  ansible.builtin.debug:
    msg: 
      - "{{ '=' * 70 }}"
      - "{{ ' DRY-RUN MODE ENABLED - No changes will be made' if cloudflare_dry_run else 'âœ“ DEPLOY MODE - Changes will be applied' }}"
      - "  Survey value: {{ _original_dry_run_value }}"
      - "  Effective mode: {{ 'DRY RUN' if cloudflare_dry_run else 'DEPLOY' }}"
      - "{{ '=' * 70 }}"
  tags:
    - always

- import_tasks: validate.yml
  run_once: true
  tags:
    - cloudflare_configuration

- import_tasks: domain.yml
  run_once: true
  when: cloudflare_scope | default('all') in ['all', 'domain']
  tags:
    - cloudflare_configuration
    - cloudflare_domain

- import_tasks: network.yml
  run_once: true
  when: cloudflare_scope | default('all') in ['all', 'network']
  tags:
    - cloudflare_configuration
    - cloudflare_network

- import_tasks: dns.yml
  run_once: true
  when: cloudflare_scope | default('all') in ['all', 'dns']
  tags:
    - cloudflare_configuration
    - cloudflare_dns

- import_tasks: notifications.yml
  run_once: true
  when: cloudflare_scope | default('all') in ['all', 'notifications']
  tags:
    - cloudflare_configuration
    - cloudflare_notifications

- name: cloudflare | Display completion summary
  ansible.builtin.debug:
    msg: "{{ lookup('template', 'completion_summary.j2') | from_yaml }}"
  run_once: true
  tags: [always]
