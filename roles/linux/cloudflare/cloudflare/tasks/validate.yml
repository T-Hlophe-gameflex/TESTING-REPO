---

- name: cloudflare | Build zones from survey variable
  ansible.builtin.set_fact:
    cloudflare_zones: "{{ [{'name': cloudflare_zone_name, 'jump_start': false, 'type': 'full'}] }}"
  when:
    - cloudflare_zone_name is defined
    - cloudflare_zones is not defined
  tags: cloudflare_configuration

- name: cloudflare | Set default zone
  ansible.builtin.set_fact:
    cloudflare_zone_name: "{{ cloudflare_zones[0].name if cloudflare_zones is defined and cloudflare_zones | length > 0 else 'not_configured' }}"
  when: cloudflare_zone_name is not defined
  tags: cloudflare_configuration

- name: cloudflare | Display execution banner
  ansible.builtin.debug:
    msg:
      - "======================================================================"
      - "  Cloudflare Configuration"
      - "  Domain: {{ platform_domain | default(effective_zone_name) | default('N/A') }}"
      - "  Platform: {{ platform_id | default('(domain-wide)') }}"
      - "  Scope: {{ cloudflare_scope | default('all') }}"
      - "  Ticket: {{ ticket_number | default('NOT PROVIDED') }}"
      - "======================================================================"
  tags: cloudflare_configuration

- name: cloudflare | Validate required variables
  ansible.builtin.assert:
    that:
      - cloudflare_api_email is defined and cloudflare_api_email != ""
      - cloudflare_api_key is defined and cloudflare_api_key != ""
      - cloudflare_account_id is defined and cloudflare_account_id != ""
      - effective_zone_name is defined
      - ticket_number is defined and ticket_number != ""
    fail_msg: "Missing required variables: cloudflare_api_email, cloudflare_api_key, cloudflare_account_id, zone name, or ticket_number"
    success_msg: "âœ“ All required variables validated"
  tags: cloudflare_configuration

- name: cloudflare | Load domain-level configuration
  ansible.builtin.include_vars:
    file: "{{ role_path }}/vars/domain.yml"
  ignore_errors: true
  no_log: true
  tags: cloudflare_configuration

- name: cloudflare | Load network-level configuration
  ansible.builtin.include_vars:
    file: "{{ role_path }}/vars/network.yml"
  ignore_errors: true
  no_log: true
  tags: cloudflare_configuration

- name: cloudflare | DNS records will be loaded from platform files
  ansible.builtin.debug:
    msg: "DNS records for {{ platform_id | default('domain-wide') }} will be loaded from platform-specific config"
  when:
    - platform_id is defined
    - platform_id != ""
  tags: cloudflare_configuration

- name: cloudflare | Load notifications configuration
  ansible.builtin.include_vars:
    file: "{{ role_path }}/vars/notifications.yml"
  when: enable_notifications | default(true)
  ignore_errors: true
  no_log: true
  tags: cloudflare_configuration

- name: cloudflare | Debug platform file paths
  ansible.builtin.debug:
    msg:
      - "Platform ID: {{ platform_id }}"
      - "Project Dir: {{ playbook_dir }}"
      - "Region: {{ cloudflare_region | default('TEST') }}"
      - "Looking for platform file in: {{ playbook_dir }}/inventories/{{ cloudflare_region | default('TEST') }}/group_vars/all/platforms/"
  when:
    - platform_id is defined
    - platform_id != ""
  tags: cloudflare_configuration

- name: cloudflare | Find platform environment directories in selected region
  ansible.builtin.find:
    paths: "{{ playbook_dir }}/inventories/{{ cloudflare_region | default('TEST') }}/group_vars/all/platforms"
    file_type: directory
    recurse: no
  register: platform_env_dirs
  when:
    - platform_id is defined
    - platform_id != ""
  tags: cloudflare_configuration

- name: cloudflare | Build platform file search paths
  ansible.builtin.set_fact:
    platform_search_paths: "{{ platform_env_dirs.files | map(attribute='path') | map('regex_replace', '$', '/' + platform_id + '.yml') | list }}"
  when:
    - platform_id is defined
    - platform_id != ""
    - platform_env_dirs.matched > 0
  tags: cloudflare_configuration

- name: cloudflare | Load platform-specific configuration dynamically
  ansible.builtin.include_vars:
    file: "{{ item }}"
  with_first_found:
    - files: "{{ platform_search_paths }}"
      skip: true
  when:
    - platform_id is defined
    - platform_id != ""
    - platform_search_paths is defined
  no_log: true
  tags: cloudflare_configuration

- name: cloudflare | Load platform-specific configuration from inventory
  ansible.builtin.debug:
    msg:
      - "Platform configuration loaded via Ansible inventory group_vars"
      - "Platform: {{ platform_id | default('N/A') }}"
      - "Region: {{ cloudflare_region | default('TEST') }}"
      - "Environment: {{ platform_type | default('N/A') }}"
      - "IP Addresses: {{ ipAddresses | default({}) | length }} configured"
  tags: cloudflare_configuration
  when:
    - platform_id is defined
    - platform_id != ""

- name: cloudflare | Set effective zone name
  ansible.builtin.set_fact:
    effective_zone_name: "{{ platform_domain | default(cloudflare_zone_name_override) | default(cloudflare_zone_name) }}"
  tags: cloudflare_configuration

- name: cloudflare | Verify platform configuration loaded
  ansible.builtin.assert:
    that:
      - platform_id is defined
      - platform_type is defined
      - ipAddresses is defined
      - ipAddresses | length > 0
    fail_msg: |
      Platform configuration not loaded from inventory.
      Region: {{ cloudflare_region | default('TEST') }}
      Platform ID: {{ platform_id | default('N/A') }}
      
      Searched in these locations:
      {% if platform_search_paths is defined %}
      {% for path in platform_search_paths %}
        - {{ path }}
      {% endfor %}
      {% else %}
        - No environment directories found in {{ playbook_dir }}/inventories/{{ cloudflare_region | default('TEST') }}/group_vars/all/platforms/
      {% endif %}
      
      Make sure platform file exists in the {{ cloudflare_region | default('TEST') }} inventory and contains:
        - platform_id
        - platform_type
        - ipAddresses
    success_msg: "Platform {{ platform_id }} configuration validated successfully"
  when:
    - platform_id is defined
    - platform_id != ""
  tags: cloudflare_configuration

- name: cloudflare validation | Validate required variables
  ansible.builtin.assert:
    that:
      - cloudflare_api_email is defined
      - cloudflare_api_email != ""
      - cloudflare_api_key is defined
      - cloudflare_api_key != ""
      - cloudflare_account_id is defined
      - cloudflare_account_id != ""
    fail_msg: "Missing required Cloudflare API credentials"
    success_msg: "Cloudflare credentials are defined"
  tags: cloudflare_configuration

- name: cloudflare validation | Testing API connectivity
  ansible.builtin.uri:
    url: "{{ cloudflare_api_url }}/user"
    method: GET
    headers:
      X-Auth-Email: "{{ cloudflare_api_email }}"
      X-Auth-Key: "{{ cloudflare_api_key }}"
      Content-Type: "application/json"
    return_content: yes
    status_code: 200
    timeout: "{{ cloudflare_api_timeout | default(30) }}"
    validate_certs: "{{ cloudflare_validate_certs | default(true) }}"
  register: _api_token_validation
  retries: "{{ cloudflare_api_retries | default(3) }}"
  delay: "{{ cloudflare_api_delay | default(5) }}"
  until: _api_token_validation.status == 200
  when: validate_api_token | default(true) | bool
  no_log: true
  tags: cloudflare_configuration

- name: cloudflare validation | Verify account access
  ansible.builtin.uri:
    url: "{{ cloudflare_api_url }}/accounts/{{ cloudflare_account_id }}"
    method: GET
    headers:
      X-Auth-Email: "{{ cloudflare_api_email }}"
      X-Auth-Key: "{{ cloudflare_api_key }}"
      Content-Type: "application/json"
    return_content: yes
    status_code: 200
    timeout: "{{ cloudflare_api_timeout | default(30) }}"
    validate_certs: "{{ cloudflare_validate_certs | default(true) }}"
  register: _account_verification
  retries: "{{ cloudflare_api_retries | default(3) }}"
  delay: "{{ cloudflare_api_delay | default(5) }}"
  until: _account_verification.status == 200
  when: validate_api_token | default(true) | bool
  no_log: true
  tags: cloudflare_configuration

- name: cloudflare validation | Display summary
  ansible.builtin.debug:
    msg:
      - " Configuration validated successfully"
      - " Domain: {{ effective_zone_name }}"
      - " Platform: {{ platform_id | default('(domain-wide)') }}"
      - " API: Connected and authenticated"
      - " DNS Records: {{ cloudflare_dns_records | default([]) | length }} configured"
  tags: cloudflare_configuration
