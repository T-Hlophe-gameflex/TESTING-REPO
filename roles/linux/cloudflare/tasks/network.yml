---
- name: cloudflare network | Get zone ID for network operations
  ansible.builtin.uri:
    url: "{{ cloudflare_api_url }}/zones?name={{ effective_zone_name }}"
    method: GET
    headers:
      X-Auth-Email: "{{ cloudflare_api_email }}"
      X-Auth-Key: "{{ cloudflare_api_key }}"
      Content-Type: "application/json"
    return_content: yes
    status_code: 200
  register: _zone_lookup
  when: cloudflare_scope | default('all') in ['all', 'network']
  tags:
    - cloudflare_configuration
    - cloudflare_network

- name: cloudflare network | Set zone ID fact
  ansible.builtin.set_fact:
    cloudflare_zone_id: "{{ _zone_lookup.json.result[0].id }}"
  when: 
    - cloudflare_scope | default('all') in ['all', 'network']
    - _zone_lookup is defined
    - _zone_lookup.json is defined
    - _zone_lookup.json.result | length > 0
  tags:
    - cloudflare_configuration
    - cloudflare_network

- name: cloudflare network | display configuration banner
  ansible.builtin.debug:
    msg: "Configuring network settings for {{ effective_zone_name }}..."
  tags:
    - cloudflare_configuration
    - cloudflare_network

- name: cloudflare network | Display dry-run health check creation
  ansible.builtin.debug:
    msg:
      - " DRY-RUN: Would CREATE {{ cloudflare_network_health_checks | length }} health check(s):"
      - "{% for check in cloudflare_network_health_checks %}  - {{ check.name }}: {{ check.type | default('https') }}://{{ check.address }}{{ check.path | default('/') }} (Interval: {{ check.interval | default(60) }}s){% endfor %}"
  loop: []
  when:
    - cloudflare_dry_run | default(false) | bool
    - cloudflare_zone_id is defined
    - cloudflare_network_health_checks | length > 0
  tags:
    - cloudflare_configuration
    - cloudflare_network
    - cloudflare_health_checks

- name: cloudflare network | Display dry-run IP Geolocation setting
  ansible.builtin.debug:
    msg:
      - "DRY-RUN: Would {{ 'ENABLE' if cloudflare_network_ip_geolocation.enabled else 'DISABLE' }} IP Geolocation"
  when:
    - cloudflare_dry_run | default(false) | bool
    - cloudflare_zone_id is defined
    - cloudflare_network_ip_geolocation is defined
    - cloudflare_network_ip_geolocation.enabled is defined
  tags:
    - cloudflare_configuration
    - cloudflare_network
    - cloudflare_ip_geolocation

- name: cloudflare network | Display dry-run network settings
  ansible.builtin.debug:
    msg:
      - "  DRY-RUN: Would CONFIGURE network settings:"
      - "  IPv6: {{ 'ON' if cloudflare_network_settings.ipv6 else 'OFF' }}"
      - "  WebSockets: {{ 'ON' if cloudflare_network_settings.websockets else 'OFF' }}"
      - "  Pseudo IPv4: {{ cloudflare_network_settings.pseudo_ipv4 | upper }}"
      - "  IP Geolocation: {{ 'ON' if cloudflare_network_settings.ip_geolocation else 'OFF' }}"
  when:
    - cloudflare_dry_run | default(false) | bool
    - cloudflare_zone_id is defined
    - cloudflare_network_settings is defined
  tags:
    - cloudflare_configuration
    - cloudflare_network

- name: cloudflare network | Build dynamic health checks from platform DNS records
  ansible.builtin.set_fact:
    cloudflare_network_health_checks: "{{ cloudflare_network_health_checks | default([]) + [health_check_item] }}"
  vars:
    health_check_item:
      name: "{{ item.key }}_{{ platform_id | lower }}"
      address: "{{ item.key }}-{{ platform_id | lower }}.{{ platform_domain }}"
      description: "{{ item.key | title }} service health monitoring"
      type: "{{ cloudflare_network_health_checks_defaults.type }}"
      path: "/gamelaunch/api/v2.0/heartbeat/{{ platform_id }}/IFO/20/gameProviders"
      port: "{{ cloudflare_network_health_checks_defaults.port | int }}"
      interval: "{{ cloudflare_network_health_checks_defaults.interval | int }}"
      retries: "{{ cloudflare_network_health_checks_defaults.retries | int }}"
      timeout: "{{ cloudflare_network_health_checks_defaults.timeout | int }}"
      expected_codes: "{{ cloudflare_network_health_checks_defaults.expected_codes }}"
      check_regions: "{{ cloudflare_network_health_checks_defaults.check_regions }}"
  loop: "{{ ipAddresses | dict2items }}"
  loop_control:
    label: "{{ item.key }}-{{ platform_id | lower }}.{{ platform_domain }}"
  when:
    - cloudflare_network_health_checks_enabled | default(false) | bool
    - ipAddresses is defined
    - platform_id is defined
    - platform_domain is defined
  tags:
    - cloudflare_configuration
    - cloudflare_network
    - cloudflare_health_checks

- name: cloudflare network | create health checks
  ansible.builtin.uri:
    url: "{{ cloudflare_api_url }}/zones/{{ cloudflare_zone_id }}/healthchecks"
    method: POST
    headers:
      X-Auth-Email: "{{ cloudflare_api_email }}"
      X-Auth-Key: "{{ cloudflare_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.name }}"
      description: "{{ item.description | default('Health check for ' + item.name) }}"
      check_regions: "{{ item.check_regions | default(['WEU', 'ENAM']) }}"
      type: "{{ item.type | default('HTTPS') | upper }}"
      address: "{{ item.address }}"
      interval: "{{ item.interval | default(60) | int }}"
      retries: "{{ item.retries | default(2) | int }}"
      timeout: "{{ item.timeout | default(5) | int }}"
      http_config:
        method: "GET"
        port: "{{ item.port | default(443) | int }}"
        path: "{{ item.path | default('/') }}"
        expected_codes: "{{ item.expected_codes | default('200') }}"
        expected_body: "{{ item.expected_body | default('') }}"
        follow_redirects: "{{ item.follow_redirects | default(false) }}"
        allow_insecure: "{{ item.allow_insecure | default(false) }}"
    status_code: [200, 409]
    return_content: true
  loop: "{{ cloudflare_network_health_checks | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  register: _health_checks_result
  when:
    - not (cloudflare_dry_run | default(false) | bool)
    - cloudflare_zone_id is defined
    - cloudflare_network_health_checks | length > 0
  changed_when: _health_checks_result.status == 200
  failed_when: false  
  tags:
    - cloudflare_configuration
    - cloudflare_network
    - cloudflare_health_checks

- name: cloudflare network | enable IP Geolocation
  ansible.builtin.uri:
    url: "{{ cloudflare_api_url }}/zones/{{ cloudflare_zone_id }}/settings/ip_geolocation"
    method: PATCH
    headers:
      X-Auth-Email: "{{ cloudflare_api_email }}"
      X-Auth-Key: "{{ cloudflare_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      value: "{{ 'on' if cloudflare_network_ip_geolocation.enabled else 'off' }}"
    status_code: [200, 400]
    return_content: true
  register: _ip_geolocation_result
  when:
    - not (cloudflare_dry_run | default(false) | bool)
    - cloudflare_zone_id is defined
    - cloudflare_network_ip_geolocation is defined
    - cloudflare_network_ip_geolocation.enabled is defined
  changed_when: 
    - _ip_geolocation_result.status == 200
    - _ip_geolocation_result.json.success | default(false)
  failed_when: false
  tags:
    - cloudflare_configuration
    - cloudflare_network
    - cloudflare_ip_geolocation

- name: cloudflare network | configure IPv6 setting
  ansible.builtin.uri:
    url: "{{ cloudflare_api_url }}/zones/{{ cloudflare_zone_id }}/settings/ipv6"
    method: PATCH
    headers:
      X-Auth-Email: "{{ cloudflare_api_email }}"
      X-Auth-Key: "{{ cloudflare_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      value: "{{ 'on' if cloudflare_network_settings.ipv6 else 'off' }}"
    status_code: [200, 400]
    return_content: true
  register: _ipv6_result
  when:
    - not (cloudflare_dry_run | default(false) | bool)
    - cloudflare_zone_id is defined
    - cloudflare_network_settings is defined
    - cloudflare_network_settings.ipv6 is defined
  changed_when: 
    - _ipv6_result.status == 200
    - _ipv6_result.json.success | default(false)
  failed_when: false
  tags:
    - cloudflare_configuration
    - cloudflare_network

- name: cloudflare network | configure WebSockets setting
  ansible.builtin.uri:
    url: "{{ cloudflare_api_url }}/zones/{{ cloudflare_zone_id }}/settings/websockets"
    method: PATCH
    headers:
      X-Auth-Email: "{{ cloudflare_api_email }}"
      X-Auth-Key: "{{ cloudflare_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      value: "{{ 'on' if cloudflare_network_settings.websockets else 'off' }}"
    status_code: [200, 400]
    return_content: true
  register: _websockets_result
  when:
    - not (cloudflare_dry_run | default(false) | bool)
    - cloudflare_zone_id is defined
    - cloudflare_network_settings is defined
    - cloudflare_network_settings.websockets is defined
  changed_when: 
    - _websockets_result.status == 200
    - _websockets_result.json.success | default(false)
  failed_when: false
  tags:
    - cloudflare_configuration
    - cloudflare_network

- name: cloudflare network | configure Pseudo IPv4 setting
  ansible.builtin.uri:
    url: "{{ cloudflare_api_url }}/zones/{{ cloudflare_zone_id }}/settings/pseudo_ipv4"
    method: PATCH
    headers:
      X-Auth-Email: "{{ cloudflare_api_email }}"
      X-Auth-Key: "{{ cloudflare_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      value: "{{ cloudflare_network_settings.pseudo_ipv4 }}"
    status_code: [200, 400]
    return_content: true
  register: _pseudo_ipv4_result
  when:
    - not (cloudflare_dry_run | default(false) | bool)
    - cloudflare_zone_id is defined
    - cloudflare_network_settings is defined
    - cloudflare_network_settings.pseudo_ipv4 is defined
  changed_when: 
    - _pseudo_ipv4_result.status == 200
    - _pseudo_ipv4_result.json.success | default(false)
  failed_when: false
  tags:
    - cloudflare_configuration
    - cloudflare_network

- name: cloudflare network | display IP Geolocation status
  ansible.builtin.debug:
    msg:
      - "IP Geolocation Configuration:"
      - "  Status Code: {{ _ip_geolocation_result.status | default('N/A') }}"
      - "  Success: {{ _ip_geolocation_result.json.success | default('N/A') }}"
      - "  Setting Value: {{ _ip_geolocation_result.json.result.value | default('N/A') }}"
      - "  Errors: {{ _ip_geolocation_result.json.errors | default([]) }}"
      - "  Messages: {{ _ip_geolocation_result.json.messages | default([]) }}"
  when:
    - _ip_geolocation_result is defined
    - _ip_geolocation_result.json is defined
  tags:
    - cloudflare_configuration
    - cloudflare_network
    - cloudflare_ip_geolocation

- name: cloudflare network | display network configuration summary
  ansible.builtin.debug:
    msg:
      - "Network configuration applied"
      - "Health Checks: {{ cloudflare_network_health_checks | default([]) | length }}"
      - "IPv6: {{ 'Enabled' if (cloudflare_network_settings.ipv6 | default(false)) else 'Disabled' }}"
      - "WebSockets: {{ 'Enabled' if (cloudflare_network_settings.websockets | default(false)) else 'Disabled' }}"
      - "Pseudo IPv4: {{ cloudflare_network_settings.pseudo_ipv4 | default('off') | upper }}"
      - "IP Geolocation: {{ 'Enabled' if (cloudflare_network_settings.ip_geolocation | default(false)) else 'Disabled' }}"
  tags:
    - cloudflare_configuration
    - cloudflare_network
