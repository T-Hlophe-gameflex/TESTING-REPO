---

- name: cloudflare dns | Build dynamic DNS records from platform variables
  ansible.builtin.set_fact:
    cloudflare_dns_records: |
      {% set records = [] %}
      {% set record_list = dns_record_types | default(standard_dns_record_types | default([])) %}
      {% for record_type in record_list %}
      {% if record_type.type | default('A') == 'A' and record_type.ip_key is defined %}
      {% set ip_value = ipAddresses[record_type.ip_key] | default('') %}
      {% if ip_value != '' %}
      {% set record_dict = {
          'name': record_type.name ~ (('-' ~ (platform_id | lower)) if record_type.name not in ['@', 'www', 'backoffice'] else ''),
          'type': 'A',
          'content': ip_value,
          'ttl': dns_ttl | default(default_dns_ttl | default(1)),
          'proxied': dns_proxied | default(default_dns_proxied | default(true)),
          'comment': platform_id ~ ' - ' ~ record_type.comment ~ ' (' ~ (platform_type | default(env_type | default('unknown'))) ~ ' environment)'
      } %}
      {% set _ = records.append(record_dict) %}
      {% endif %}
      {% elif record_type.type | default('A') == 'CNAME' %}
      {% set record_dict = {
          'name': record_type.name,
          'type': 'CNAME',
          'content': record_type.content,
          'ttl': dns_ttl | default(default_dns_ttl | default(1)),
          'proxied': dns_proxied | default(default_dns_proxied | default(true)),
          'comment': platform_id ~ ' - ' ~ record_type.comment ~ ' (' ~ (platform_type | default(env_type | default('unknown'))) ~ ' environment)'
      } %}
      {% set _ = records.append(record_dict) %}
      {% endif %}
      {% endfor %}
      {{ records }}
  when:
    - platform_id is defined
  tags:
    - cloudflare_configuration
    - cloudflare_dns

- name: cloudflare dns | Set target zone name
  ansible.builtin.set_fact:
    target_zone_name: "{{ platform_domain | default(effective_zone_name) | default(cloudflare_zone_name) }}"
  tags:
    - cloudflare_configuration
    - cloudflare_dns

- name: cloudflare dns | Display configuration banner
  ansible.builtin.debug:
    msg:
      - "Configuring DNS for zone: {{ target_zone_name }}"
      - "Platform: {{ platform_id | default('(domain-wide)') }}"
      - "DNS Records: {{ cloudflare_dns_records | default([]) | length }}"
  tags:
    - cloudflare_configuration
    - cloudflare_dns

- name: cloudflare dns | Get zone ID
  ansible.builtin.uri:
    url: "https://api.cloudflare.com/client/v4/zones?name={{ target_zone_name }}"
    method: GET
    headers: "{{ cloudflare_auth_headers }}"
    return_content: true
    validate_certs: true
  register: zone_lookup
  when:
    - target_zone_name is defined
    - cloudflare_dns_records is defined
    - cloudflare_dns_records | length > 0
  tags:
    - cloudflare_configuration
    - cloudflare_dns
    - cloudflare_dns_zone_lookup

- name: cloudflare dns | Set zone_id fact
  ansible.builtin.set_fact:
    cloudflare_zone_id: "{{ zone_lookup.json.result[0].id }}"
  when:
    - zone_lookup is defined
    - zone_lookup.json is defined
    - zone_lookup.json.result is defined
    - zone_lookup.json.result | length > 0
  tags:
    - cloudflare_configuration
    - cloudflare_dns
    - cloudflare_dns_zone_lookup

- name: cloudflare dns | Check if record exists
  ansible.builtin.uri:
    url: "https://api.cloudflare.com/client/v4/zones/{{ cloudflare_zone_id }}/dns_records?type={{ item.type }}&name={{ target_zone_name if item.name == '@' else item.name ~ '.' ~ target_zone_name }}"
    method: GET
    headers:
      X-Auth-Email: "{{ cloudflare_api_email }}"
      X-Auth-Key: "{{ cloudflare_api_key }}"
    return_content: true
    validate_certs: true
  register: dns_record_lookup
  loop: "{{ cloudflare_dns_records | default([]) }}"
  loop_control:
    label: "{{ item.name }} ({{ item.type }})"
  when:
    - cloudflare_zone_id is defined
    - cloudflare_dns_records is defined
    - cloudflare_dns_records | length > 0
  tags:
    - cloudflare_configuration
    - cloudflare_dns
    - cloudflare_dns_lookup

- name: cloudflare dns | Display dry-run changes (no actual changes)
  ansible.builtin.debug:
    msg:
      - "ðŸ” DRY-RUN: Would {{ 'UPDATE' if (item.1 is defined and item.1.json is defined and item.1.json.result | length > 0) else 'CREATE' }} DNS record:"
      - "  Name: {{ target_zone_name if item.0.name == '@' else item.0.name ~ '.' ~ target_zone_name }}"
      - "  Type: {{ item.0.type }}"
      - "  Content: {{ item.0.content }}"
      - "  TTL: {{ item.0.ttl | default(1) }}"
      - "  Proxied: {{ item.0.proxied | default(false) }}"
  loop: "{{ cloudflare_dns_records | default([]) | zip(dns_record_lookup.results | default([])) | list }}"
  loop_control:
    label: "{{ item.0.name }} ({{ item.0.type }})"
  when:
    - cloudflare_dry_run | default(false) | bool
    - cloudflare_zone_id is defined
    - cloudflare_dns_records is defined
    - cloudflare_dns_records | length > 0
    - item.1 is defined
  tags:
    - cloudflare_configuration
    - cloudflare_dns

- name: cloudflare dns | Create or update DNS records
  ansible.builtin.uri:
    url: >-
      https://api.cloudflare.com/client/v4/zones/{{ cloudflare_zone_id }}/dns_records{{
        '/' ~ item.1.json.result[0].id if (item.1 is defined and item.1.json is defined and item.1.json.result | length > 0) else ''
      }}
    method: "{{ 'PUT' if (item.1 is defined and item.1.json is defined and item.1.json.result | length > 0) else 'POST' }}"
    headers:
      X-Auth-Email: "{{ cloudflare_api_email }}"
      X-Auth-Key: "{{ cloudflare_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body: >-
      {{
        {
          'type': item.0.type,
          'name': (target_zone_name if item.0.name == '@' else item.0.name ~ '.' ~ target_zone_name),
          'content': item.0.content,
          'ttl': (item.0.ttl | default(1) | int),
          'proxied': (item.0.proxied | default(false) | bool)
        }
        | combine({'priority': (item.0.priority | int)} if item.0.priority is defined else {})
      }}
    return_content: true
    validate_certs: true
  loop: "{{ cloudflare_dns_records | default([]) | zip(dns_record_lookup.results | default([])) | list }}"
  loop_control:
    label: "{{ item.0.name }} ({{ item.0.type }})"
  when:
    - not (cloudflare_dry_run | default(false) | bool)
    - cloudflare_zone_id is defined
    - cloudflare_dns_records is defined
    - cloudflare_dns_records | length > 0
    - item.1 is defined
  register: dns_create_result
  tags:
    - cloudflare_configuration
    - cloudflare_dns
    - cloudflare_dns_create
    - cloudflare_dns_update

- name: cloudflare dns | Display DNS configuration summary
  ansible.builtin.debug:
    msg:
      - "DNS configuration completed"
      - "Total records: {{ cloudflare_dns_records | default([]) | length }}"
      - "Record types: {{ cloudflare_dns_records | default([]) | map(attribute='type') | unique | list | join(', ') }}"
  when: cloudflare_dns_records is defined
  tags:
    - cloudflare_configuration
    - cloudflare_dns
