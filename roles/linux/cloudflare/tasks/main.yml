---

- name: cloudflare | Set dry-run mode
  ansible.builtin.set_fact:
    cloudflare_dry_run: "{{ ansible_check_mode | default(false) or (cloudflare_dry_run | default(false) | bool) }}"
  tags:
    - always

- name: cloudflare | Display dry-run mode status
  ansible.builtin.debug:
    msg: "{{ 'üîç DRY-RUN MODE ENABLED - No changes will be made' if cloudflare_dry_run else '‚úì DEPLOY MODE - Changes will be applied' }}"
  tags:
    - always

- name: cloudflare | Build dynamic DNS records from platform variables
  ansible.builtin.set_fact:
    cloudflare_dns_records: |
      {% set records = [] %}
      {% set record_list = dns_record_types | default(standard_dns_record_types | default([])) %}
      {% for record_type in record_list %}
      {% if record_type.type | default('A') == 'A' and record_type.ip_key is defined %}
      {% set ip_value = ipAddresses[record_type.ip_key] | default('') %}
      {% if ip_value != '' %}
      {% set record_dict = {
          'name': record_type.name ~ (('-' ~ (platform_id | lower)) if record_type.name not in ['@', 'www', 'backoffice'] else ''),
          'type': 'A',
          'content': ip_value,
          'ttl': dns_ttl | default(default_dns_ttl | default(1)),
          'proxied': dns_proxied | default(default_dns_proxied | default(true)),
          'comment': platform_id ~ ' - ' ~ record_type.comment ~ ' (' ~ (platform_type | default(env_type | default('unknown'))) ~ ' environment)'
      } %}
      {% set _ = records.append(record_dict) %}
      {% endif %}
      {% elif record_type.type | default('A') == 'CNAME' %}
      {% set record_dict = {
          'name': record_type.name,
          'type': 'CNAME',
          'content': record_type.content,
          'ttl': dns_ttl | default(default_dns_ttl | default(1)),
          'proxied': dns_proxied | default(default_dns_proxied | default(true)),
          'comment': platform_id ~ ' - ' ~ record_type.comment ~ ' (' ~ (platform_type | default(env_type | default('unknown'))) ~ ' environment)'
      } %}
      {% set _ = records.append(record_dict) %}
      {% endif %}
      {% endfor %}
      {{ records }}
  when:
    - platform_id is defined
  tags:
    - cloudflare_configuration

- import_tasks: validate.yml
  run_once: true
  tags:
    - cloudflare_configuration

- import_tasks: global.yml
  run_once: true
  when: cloudflare_scope | default('all') in ['all', 'global']
  tags:
    - cloudflare_configuration
    - cloudflare_global

- import_tasks: domain.yml
  run_once: true
  when: cloudflare_scope | default('all') in ['all', 'domain']
  tags:
    - cloudflare_configuration
    - cloudflare_domain

- import_tasks: network.yml
  run_once: true
  when: cloudflare_scope | default('all') in ['all', 'network']
  tags:
    - cloudflare_configuration
    - cloudflare_network

- import_tasks: dns.yml
  run_once: true
  when: cloudflare_scope | default('all') in ['all', 'dns']
  tags:
    - cloudflare_configuration
    - cloudflare_dns

- import_tasks: platform.yml
  run_once: true
  when: cloudflare_scope | default('all') in ['all', 'platform']
  tags:
    - cloudflare_configuration
    - cloudflare_platform

- import_tasks: notifications.yml
  run_once: true
  when: cloudflare_scope | default('all') in ['all', 'notifications']
  tags:
    - cloudflare_configuration
    - cloudflare_notifications

- name: cloudflare | Display completion summary
  ansible.builtin.debug:
    msg:
      - "======================================================================"
      - "  Cloudflare Configuration Complete!"
      - "======================================================================"
      - ""
      - "Configuration Details:"
      - "  Domain: {{ effective_zone_name | default(cloudflare_zone_name) }}"
      - "  Platform: {{ platform_id | default('(domain-wide operation)') }}"
      - "  Scope: {{ cloudflare_scope | default('all') }}"
      - "  Ticket: {{ ticket_number | default('N/A') }}"
      - ""
      - "What was configured:"
      - "{% if cloudflare_scope | default('all') in ['all', 'dns'] %}  ‚úì DNS records ({{ cloudflare_dns_records | default([]) | length }} records){% endif %}"
      - "{% if cloudflare_scope | default('all') in ['all', 'domain'] %}  ‚úì Domain settings (SSL, cache, Argo){% endif %}"
      - "{% if cloudflare_scope | default('all') in ['all', 'global'] %}  ‚úì Global settings (security headers, rate limiting){% endif %}"
      - "{% if cloudflare_scope | default('all') in ['all', 'network'] %}  ‚úì Network settings (health checks, firewall){% endif %}"
      - ""
      - "Verify your changes:"
      - "  Dashboard: https://dash.cloudflare.com/"
      - "  Domain: {{ effective_zone_name | default(cloudflare_zone_name) }}"
      - "======================================================================"
  run_once: true
  tags: [always]
