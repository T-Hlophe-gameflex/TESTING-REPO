---

- name: cloudflare platform | Display configuration banner
  ansible.builtin.debug:
    msg: "Applying platform-specific configuration for {{ platform_id | default('N/A') }}..."
  tags:
    - cloudflare_configuration
    - cloudflare_platform

- name: cloudflare platform | Skip if no platform ID
  ansible.builtin.debug:
    msg: "No platform_id defined, skipping platform-specific configuration"
  when:
    - platform_id is not defined or platform_id == ""
  tags:
    - cloudflare_configuration
    - cloudflare_platform

- name: cloudflare platform | Create platform-specific firewall rules
  ansible.builtin.uri:
    url: "{{ cloudflare_api_url }}/zones/{{ cloudflare_zone_id }}/firewall/rules"
    method: POST
    headers:
      X-Auth-Email: "{{ cloudflare_api_email }}"
      X-Auth-Key: "{{ cloudflare_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      - action: "{{ item.action }}"
        description: "{{ item.description }}"
        filter:
          expression: "{{ item.expression }}"
        enabled: "{{ item.enabled | default(true) }}"
        priority: "{{ item.priority | default(0) }}"
    status_code: [200, 409]
    return_content: true
  loop: "{{ cloudflare_platform_firewall_rules | default([]) }}"
  loop_control:
    label: "{{ item.description }}"
  register: _firewall_rules_result
  when:
    - cloudflare_zone_id is defined
    - platform_id is defined
    - platform_id != ""
    - cloudflare_platform_firewall_rules is defined
    - cloudflare_platform_firewall_rules | length > 0
  changed_when: _firewall_rules_result.status == 200
  failed_when:
    - _firewall_rules_result.status not in [200, 409]
  tags:
    - cloudflare_configuration
    - cloudflare_platform
    - cloudflare_firewall

- name: cloudflare platform | Display platform configuration summary
  ansible.builtin.debug:
    msg:
      - "Platform configuration applied for {{ platform_id | default('N/A') }}"
      - "Firewall Rules: {{ cloudflare_platform_firewall_rules | default([]) | length }}"
  when:
    - platform_id is defined
    - platform_id != ""
  tags:
    - cloudflare_configuration
    - cloudflare_platform
